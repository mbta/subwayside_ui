defmodule SubwaysideUi.TrainTest do
  use ExUnit.Case, async: true
  alias SubwaysideUi.Train
  import Jason.Sigil

  describe "from_json_map/1" do
    test "basic parsing" do
      actual = Train.from_json_map(base_map())

      assert %Train{
               id: 2_000_812_662,
               leader_car_nbr: "1468",
               number_of_cars: 6,
               created_date: ~U[2023-04-27 13:56:15.970000Z],
               route_name: "1002",
               active_car_nbr: nil,
               speed: 0.0,
               gps_latitude: 42.437278,
               gps_longitude: -71.07084,
               destination_loc: %Train.Location{name: "Oak Grove"},
               previous_loc: %Train.Location{name: "Malden Center"},
               next_loc: %Train.Location{name: "Oak Grove"},
               running_distance: 11.147,
               flags: %Train.Flags{
                 critical?: true,
                 shop_mode?: false,
                 heartbeat_valid?: true,
                 hbl: false,
                 speed_valid?: true,
                 gps_valid?: true,
                 destination_valid?: true,
                 datetime_valid?: true,
                 time_sync_wss?: false,
                 time_sync_gps?: true
               },
               cars: [
                 %{car_nbr: "1444"},
                 %{car_nbr: "1445"},
                 %{car_nbr: "1402"},
                 %{car_nbr: "1403"},
                 %{car_nbr: "1469"},
                 %{car_nbr: "1468"}
               ]
             } = actual
    end
  end

  def base_map do
    ~J({
  "train_severity_code": "10",
  "operation_line_id": "2",
  "car_lists": [
    {
      "car_critical": "1",
      "car_mileage": 79078.0304,
      "car_nbr": "1444",
      "car_severity_code": "01",
      "car_type_code": "1",
      "dead_flg": "0",
      "gps_latitude": 42.437278,
      "gps_longitude": -71.07084,
      "last_ok_date_1": "2023-04-25T07:17:08.144876Z",
      "last_ok_date_2": "2023-04-24T18:33:55.588886Z",
      "ng_date_1": "2023-04-25T07:16:08.028105Z",
      "ng_date_2": "2023-04-24T18:34:55.660229Z",
      "update_date_1": "2023-04-25T07:17:08.144876Z",
      "update_date_2": "2023-04-24T18:34:55.660229Z"
    },
    {
      "car_critical": "1",
      "car_mileage": 78920.9846,
      "car_nbr": "1445",
      "car_severity_code": "10",
      "car_type_code": "2",
      "dead_flg": "0",
      "gps_latitude": 42.437278,
      "gps_longitude": -71.07084,
      "last_ok_date_1": null,
      "last_ok_date_2": null,
      "ng_date_1": null,
      "ng_date_2": null,
      "update_date_1": null,
      "update_date_2": null
    },
    {
      "car_critical": "1",
      "car_mileage": 81393.684,
      "car_nbr": "1402",
      "car_severity_code": "10",
      "car_type_code": "1",
      "dead_flg": "0",
      "gps_latitude": 42.437278,
      "gps_longitude": -71.07084,
      "last_ok_date_1": "2023-04-27T04:06:53.123475Z",
      "last_ok_date_2": "2023-04-21T13:07:24.802935Z",
      "ng_date_1": "2023-04-27T04:06:50.101615Z",
      "ng_date_2": "2023-04-21T13:08:24.807074Z",
      "update_date_1": "2023-04-27T04:06:53.123475Z",
      "update_date_2": "2023-04-23T07:27:30.362566Z"
    },
    {
      "car_critical": "0",
      "car_mileage": 79522.0436,
      "car_nbr": "1403",
      "car_severity_code": "00",
      "car_type_code": "2",
      "dead_flg": "0",
      "gps_latitude": 42.437278,
      "gps_longitude": -71.07084,
      "last_ok_date_1": null,
      "last_ok_date_2": null,
      "ng_date_1": null,
      "ng_date_2": null,
      "update_date_1": null,
      "update_date_2": null
    },
    {
      "car_critical": "1",
      "car_mileage": 48465.1458,
      "car_nbr": "1469",
      "car_severity_code": "01",
      "car_type_code": "2",
      "dead_flg": "0",
      "gps_latitude": 42.437278,
      "gps_longitude": -71.07084,
      "last_ok_date_1": null,
      "last_ok_date_2": null,
      "ng_date_1": null,
      "ng_date_2": null,
      "update_date_1": null,
      "update_date_2": null
    },
    {
      "car_critical": "0",
      "car_mileage": 48357.9694,
      "car_nbr": "1468",
      "car_severity_code": "00",
      "car_type_code": "1",
      "dead_flg": "0",
      "gps_latitude": 42.437278,
      "gps_longitude": -71.07084,
      "last_ok_date_1": "2023-04-27T04:48:24.096087Z",
      "last_ok_date_2": "2023-04-24T22:47:41.069597Z",
      "ng_date_1": "2023-04-27T04:47:23.061809Z",
      "ng_date_2": "2023-04-24T22:48:41.116263Z",
      "update_date_1": "2023-04-27T04:48:24.096087Z",
      "update_date_2": "2023-04-24T22:48:41.116263Z"
    }
  ],
  "comm_no": 51462,
  "car_infos": [
    {
      "ondev_status_08": 0,
      "ondev_status_33": 192,
      "load_weight_sig_2": 7928,
      "ondev_status_16": 192,
      "car_critical": "1",
      "ondev_status_17": 192,
      "air_spring_press_1": 564,
      "ondev_status_10": 192,
      "ondev_status_29": 192,
      "car_severity_code": "01",
      "ondev_status_25": 0,
      "car_nbr": "1444",
      "car_type_code": "1",
      "ondev_status_24": 0,
      "ondev_status_30": 192,
      "car_location": 1,
      "ondev_status_01": 192,
      "ondev_status_05": 192,
      "rio_cab_manned": false,
      "dead_flg": "0",
      "state_wifi_1": 1,
      "car_mileage": 79078.0304,
      "ondev_status_14": 192,
      "ondev_status_18": 192,
      "ondev_status_13": 192,
      "ondev_status_31": 192,
      "ondev_status_32": 192,
      "ondev_status_07": 192,
      "ondev_status_04": 192,
      "load_weight_sig_1": 7928,
      "wifi_status_2": "0",
      "ondev_status_15": 192,
      "ondev_status_37": 0,
      "ondev_status_22": 0,
      "state_1": 6,
      "ondev_status_02": 192,
      "wifi_status_1": "0",
      "master": false,
      "ondev_status_28": 192,
      "ers_active_cab": false,
      "rio_trans_sw_active": false,
      "ondev_status_12": 192,
      "state_wifi_2": 0,
      "mpvv": false,
      "ondev_status_20": 192,
      "ondev_status_21": 192,
      "ondev_status_09": 198,
      "ondev_status_36": 0,
      "ondev_status_26": 192,
      "air_spring_press_2": 566,
      "fst": false,
      "ondev_status_34": 192,
      "maint_pass_ver": "00.00",
      "ondev_status_06": 192,
      "ondev_status_35": 0,
      "ondev_status_27": 192,
      "ondev_status_19": 192,
      "ondev_status_23": 0,
      "ondev_status_11": 192,
      "status_1": "1",
      "cmlv": true,
      "ondev_status_03": 192
    },
    {
      "ondev_status_08": 0,
      "ondev_status_33": 192,
      "load_weight_sig_2": 7683,
      "ondev_status_16": 192,
      "car_critical": "1",
      "ondev_status_17": 192,
      "air_spring_press_1": 532,
      "ondev_status_10": 192,
      "ondev_status_29": 192,
      "car_severity_code": "10",
      "ondev_status_25": 0,
      "car_nbr": "1445",
      "car_type_code": "2",
      "ondev_status_24": 0,
      "ondev_status_30": 198,
      "car_location": 1,
      "ondev_status_01": 0,
      "ondev_status_05": 0,
      "rio_cab_manned": false,
      "dead_flg": "0",
      "state_wifi_1": null,
      "car_mileage": 78920.9846,
      "ondev_status_14": 198,
      "ondev_status_18": 192,
      "ondev_status_13": 192,
      "ondev_status_31": 192,
      "ondev_status_32": 192,
      "ondev_status_07": 202,
      "ondev_status_04": 0,
      "load_weight_sig_1": 7690,
      "wifi_status_2": null,
      "ondev_status_15": 192,
      "ondev_status_37": 128,
      "ondev_status_22": 0,
      "state_1": null,
      "ondev_status_02": 0,
      "wifi_status_1": null,
      "master": true,
      "ondev_status_28": 192,
      "ers_active_cab": false,
      "rio_trans_sw_active": false,
      "ondev_status_12": 192,
      "state_wifi_2": null,
      "mpvv": false,
      "ondev_status_20": 192,
      "ondev_status_21": 192,
      "ondev_status_09": 192,
      "ondev_status_36": 128,
      "ondev_status_26": 0,
      "air_spring_press_2": 541,
      "fst": false,
      "ondev_status_34": 0,
      "maint_pass_ver": "00.00",
      "ondev_status_06": 0,
      "ondev_status_35": 128,
      "ondev_status_27": 192,
      "ondev_status_19": 192,
      "ondev_status_23": 0,
      "ondev_status_11": 192,
      "status_1": null,
      "cmlv": true,
      "ondev_status_03": 192
    },
    {
      "ondev_status_08": 0,
      "ondev_status_33": 192,
      "load_weight_sig_2": 7712,
      "ondev_status_16": 192,
      "car_critical": "1",
      "ondev_status_17": 192,
      "air_spring_press_1": 545,
      "ondev_status_10": 192,
      "ondev_status_29": 192,
      "car_severity_code": "10",
      "ondev_status_25": 0,
      "car_nbr": "1402",
      "car_type_code": "1",
      "ondev_status_24": 0,
      "ondev_status_30": 192,
      "car_location": 1,
      "ondev_status_01": 192,
      "ondev_status_05": 128,
      "rio_cab_manned": false,
      "dead_flg": "0",
      "state_wifi_1": 1,
      "car_mileage": 81393.684,
      "ondev_status_14": 192,
      "ondev_status_18": 192,
      "ondev_status_13": 192,
      "ondev_status_31": 192,
      "ondev_status_32": 192,
      "ondev_status_07": 202,
      "ondev_status_04": 198,
      "load_weight_sig_1": 7712,
      "wifi_status_2": "0",
      "ondev_status_15": 192,
      "ondev_status_37": 0,
      "ondev_status_22": 0,
      "state_1": 6,
      "ondev_status_02": 192,
      "wifi_status_1": "0",
      "master": true,
      "ondev_status_28": 192,
      "ers_active_cab": false,
      "rio_trans_sw_active": false,
      "ondev_status_12": 192,
      "state_wifi_2": 0,
      "mpvv": true,
      "ondev_status_20": 192,
      "ondev_status_21": 192,
      "ondev_status_09": 192,
      "ondev_status_36": 0,
      "ondev_status_26": 192,
      "air_spring_press_2": 544,
      "fst": false,
      "ondev_status_34": 192,
      "maint_pass_ver": "00.02",
      "ondev_status_06": 198,
      "ondev_status_35": 0,
      "ondev_status_27": 192,
      "ondev_status_19": 192,
      "ondev_status_23": 0,
      "ondev_status_11": 192,
      "status_1": "1",
      "cmlv": true,
      "ondev_status_03": 192
    },
    {
      "ondev_status_08": 0,
      "ondev_status_33": 192,
      "load_weight_sig_2": 7434,
      "ondev_status_16": 192,
      "car_critical": "0",
      "ondev_status_17": 192,
      "air_spring_press_1": 510,
      "ondev_status_10": 192,
      "ondev_status_29": 192,
      "car_severity_code": "00",
      "ondev_status_25": 0,
      "car_nbr": "1403",
      "car_type_code": "2",
      "ondev_status_24": 0,
      "ondev_status_30": 192,
      "car_location": 1,
      "ondev_status_01": 0,
      "ondev_status_05": 0,
      "rio_cab_manned": false,
      "dead_flg": "0",
      "state_wifi_1": null,
      "car_mileage": 79522.0436,
      "ondev_status_14": 192,
      "ondev_status_18": 192,
      "ondev_status_13": 192,
      "ondev_status_31": 192,
      "ondev_status_32": 192,
      "ondev_status_07": 192,
      "ondev_status_04": 0,
      "load_weight_sig_1": 7430,
      "wifi_status_2": null,
      "ondev_status_15": 192,
      "ondev_status_37": 128,
      "ondev_status_22": 0,
      "state_1": null,
      "ondev_status_02": 0,
      "wifi_status_1": null,
      "master": false,
      "ondev_status_28": 192,
      "ers_active_cab": false,
      "rio_trans_sw_active": false,
      "ondev_status_12": 192,
      "state_wifi_2": null,
      "mpvv": false,
      "ondev_status_20": 192,
      "ondev_status_21": 192,
      "ondev_status_09": 192,
      "ondev_status_36": 128,
      "ondev_status_26": 0,
      "air_spring_press_2": 510,
      "fst": false,
      "ondev_status_34": 0,
      "maint_pass_ver": "00.00",
      "ondev_status_06": 0,
      "ondev_status_35": 128,
      "ondev_status_27": 192,
      "ondev_status_19": 192,
      "ondev_status_23": 0,
      "ondev_status_11": 192,
      "status_1": null,
      "cmlv": true,
      "ondev_status_03": 192
    },
    {
      "ondev_status_08": 0,
      "ondev_status_33": 192,
      "load_weight_sig_2": 7285,
      "ondev_status_16": 192,
      "car_critical": "1",
      "ondev_status_17": 192,
      "air_spring_press_1": 495,
      "ondev_status_10": 192,
      "ondev_status_29": 192,
      "car_severity_code": "01",
      "ondev_status_25": 0,
      "car_nbr": "1469",
      "car_type_code": "2",
      "ondev_status_24": 0,
      "ondev_status_30": 198,
      "car_location": 1,
      "ondev_status_01": 0,
      "ondev_status_05": 0,
      "rio_cab_manned": false,
      "dead_flg": "0",
      "state_wifi_1": null,
      "car_mileage": 48465.1458,
      "ondev_status_14": 192,
      "ondev_status_18": 192,
      "ondev_status_13": 192,
      "ondev_status_31": 192,
      "ondev_status_32": 192,
      "ondev_status_07": 192,
      "ondev_status_04": 0,
      "load_weight_sig_1": 7281,
      "wifi_status_2": null,
      "ondev_status_15": 192,
      "ondev_status_37": 128,
      "ondev_status_22": 0,
      "state_1": null,
      "ondev_status_02": 0,
      "wifi_status_1": null,
      "master": false,
      "ondev_status_28": 192,
      "ers_active_cab": false,
      "rio_trans_sw_active": false,
      "ondev_status_12": 192,
      "state_wifi_2": null,
      "mpvv": false,
      "ondev_status_20": 192,
      "ondev_status_21": 192,
      "ondev_status_09": 192,
      "ondev_status_36": 128,
      "ondev_status_26": 0,
      "air_spring_press_2": 494,
      "fst": false,
      "ondev_status_34": 0,
      "maint_pass_ver": "00.00",
      "ondev_status_06": 0,
      "ondev_status_35": 128,
      "ondev_status_27": 192,
      "ondev_status_19": 192,
      "ondev_status_23": 0,
      "ondev_status_11": 192,
      "status_1": null,
      "cmlv": true,
      "ondev_status_03": 192
    },
    {
      "ondev_status_08": 0,
      "ondev_status_33": 192,
      "load_weight_sig_2": 7837,
      "ondev_status_16": 192,
      "car_critical": "0",
      "ondev_status_17": 192,
      "air_spring_press_1": 555,
      "ondev_status_10": 192,
      "ondev_status_29": 192,
      "car_severity_code": "00",
      "ondev_status_25": 0,
      "car_nbr": "1468",
      "car_type_code": "1",
      "ondev_status_24": 0,
      "ondev_status_30": 192,
      "car_location": 1,
      "ondev_status_01": 192,
      "ondev_status_05": 192,
      "rio_cab_manned": false,
      "dead_flg": "0",
      "state_wifi_1": 1,
      "car_mileage": 48357.9694,
      "ondev_status_14": 192,
      "ondev_status_18": 192,
      "ondev_status_13": 192,
      "ondev_status_31": 192,
      "ondev_status_32": 192,
      "ondev_status_07": 192,
      "ondev_status_04": 192,
      "load_weight_sig_1": 7837,
      "wifi_status_2": "0",
      "ondev_status_15": 192,
      "ondev_status_37": 0,
      "ondev_status_22": 0,
      "state_1": 6,
      "ondev_status_02": 192,
      "wifi_status_1": "0",
      "master": true,
      "ondev_status_28": 192,
      "ers_active_cab": false,
      "rio_trans_sw_active": false,
      "ondev_status_12": 192,
      "state_wifi_2": 0,
      "mpvv": false,
      "ondev_status_20": 192,
      "ondev_status_21": 192,
      "ondev_status_09": 192,
      "ondev_status_36": 0,
      "ondev_status_26": 192,
      "air_spring_press_2": 558,
      "fst": false,
      "ondev_status_34": 192,
      "maint_pass_ver": "00.00",
      "ondev_status_06": 192,
      "ondev_status_35": 0,
      "ondev_status_27": 192,
      "ondev_status_19": 192,
      "ondev_status_23": 0,
      "ondev_status_11": 192,
      "status_1": "1",
      "cmlv": true,
      "ondev_status_03": 192
    }
  ],
  "comm_car_nbr": "1445",
  "train_id": 2000812662,
  "train_info_id": "200081266220230427135628421",
  "spv": true,
  "gpv": true,
  "mp3_car_nbr": "1468",
  "odv": true,
  "tsc": false,
  "leader_car_nbr": "1468",
  "gps_longitude": -71.07084,
  "tdv": true,
  "mp2_car_nbr": "1402",
  "hbl": false,
  "mp6_car_nbr": "0000",
  "number_of_cars": 6,
  "route_name": "1002",
  "train_nbr": "O2000812662",
  "primary_car_nbr": "1444",
  "mp4_car_nbr": "0000",
  "active_car_nbr": "0000",
  "hbv": true,
  "dir_code": "00",
  "mp1_car_nbr": "1444",
  "shop_mode_code": "0",
  "source_ondev_no": 768,
  "present_loc": {
    "id": 376,
    "name": "Malden Center"
  },
  "train_speed": 0.0,
  "running_distance": 11.147,
  "gps_latitude": 42.437278,
  "next_loc": {
    "id": 375,
    "name": "Oak Grove"
  },
  "mp5_car_nbr": "0000",
  "trans_date": "2023-04-27T13:56:26.969999Z",
  "created_date": "2023-04-27T13:56:15.970000Z",
  "destination_loc": {
    "id": 375,
    "name": "Oak Grove"
  },
  "train_critical": "1",
  "receive_server_name": "FWD01",
  "receive_date": "2023-04-27T13:56:28.420999Z"
})
  end
end
